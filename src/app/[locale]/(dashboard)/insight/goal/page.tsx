"use client";

import { AppSidebar } from "@/components/sidebar/app-sidebar"
import { NavActions } from "@/components/sidebar/nav-actions"
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbList,
  BreadcrumbPage,
} from "@/components/ui/breadcrumb"
import { Separator } from "@/components/ui/separator"
import {
  SidebarInset,
  SidebarProvider,
} from "@/components/ui/sidebar"
import { useCopilotAction, useCopilotAdditionalInstructions, useCopilotReadable, useCopilotChatInternal } from "@copilotkit/react-core";
import { CopilotKitCSSProperties, CopilotSidebar, useCopilotChatSuggestions } from "@copilotkit/react-ui";
import { useState, useRef, useEffect } from "react";
import { FileText, Upload, Plus, ArrowRight, ArrowLeft, X } from "lucide-react";
import { useSearchParams } from "next/navigation";
import { useRouter } from "@/i18n/navigation";
import { useTranslations } from "next-intl";
import { useDraft } from "@/contexts/draft";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { useFormStore } from "@/stores/form-store";
import {
  Stepper,
  StepperItem,
  StepperTrigger,
  StepperIndicator,
  StepperSeparator,
  StepperTitle,
  StepperDescription,
  StepperNav
} from "@/components/stepper";
import { Check } from "lucide-react";

interface FormData {
  productName: string;
  businessType: string;
  targetUsers: string;
  researchGoals: string;
  productSolution: (File & { _content?: string })[];
}

export default function Page() {
  const t = useTranslations('goal');
  const searchParams = useSearchParams();
  const { setHasDraft } = useDraft();
  const {
    formData,
    updateField,
    hasData,
    setFormData,
    clearForm,
    attachments,
    initialMessage,
    clearAttachments,
    setInitialMessage
  } = useFormStore();

  const fileInputRef = useRef<HTMLInputElement>(null);
  const router = useRouter();

  // Ê£ÄÊµãË°®ÂçïÊï∞ÊçÆÂèòÂåñÔºåÊõ¥Êñ∞ËçâÁ®øÁä∂ÊÄÅ
  useEffect(() => {
    setHasDraft(hasData());
  }, [formData, setHasDraft, hasData]);

  // ÂêåÊ≠• dashboard ‰∏ä‰º†ÁöÑÈôÑ‰ª∂Âà∞‰∫ßÂìÅÊñπÊ°àÊñá‰ª∂ÔºàÂè™Âú®ÂàùÂßãÂä†ËΩΩÊó∂ÂêåÊ≠•‰∏ÄÊ¨°Ôºâ
  const hasSyncedAttachmentsRef = useRef(false);

  useEffect(() => {
    // Âè™Âú®ÂàùÂßãÂä†ËΩΩÊó∂ÂêåÊ≠•‰∏ÄÊ¨°Ôºå‰πãÂêé‰∏çÂÜçÈáçÊñ∞ÂêåÊ≠•
    if (hasSyncedAttachmentsRef.current) return;
    if (!attachments || attachments.length === 0) return;
    if (formData.productSolution && formData.productSolution.length > 0) return; // Â∑≤ÊúâÊñá‰ª∂Ôºå‰∏çË¶ÜÁõñ

    // Â∞ÜÈôÑ‰ª∂ËΩ¨Êç¢‰∏∫‰∫ßÂìÅÊñπÊ°àÊñá‰ª∂
    const convertAttachmentsToFiles = async () => {
      const filePromises = attachments.map(async (item: any) => {
        try {
          let file: File;

          // ‰ºòÂÖà‰ΩøÁî®ÂéüÂßãÊñá‰ª∂ÂØπË±°
          if (item.originFileObj) {
            file = item.originFileObj;
          } else if (item.url) {
            // Â§áÁî®ÊñπÊ°àÔºö‰ªé URL Ëé∑ÂèñÊñá‰ª∂
            const response = await fetch(item.url);
            const blob = await response.blob();
            file = new File([blob], item.name, { type: item.type });
          } else {
            return null;
          }

          // ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ‰∏∫ base64
          return new Promise<File & { _content?: string }>((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const content = e.target?.result as string;
              const fileWithContent = Object.assign(file, { _content: content });
              resolve(fileWithContent);
            };
            reader.readAsDataURL(file);
          });
        } catch (error) {
          console.warn('Êó†Ê≥ïËΩ¨Êç¢ÈôÑ‰ª∂:', item.name, error);
          return null;
        }
      });

      const files = await Promise.all(filePromises);
      const validFiles = files.filter((f): f is File & { _content?: string } => f !== null);

      if (validFiles.length > 0) {
        // Âè™ÊúâÂú®ÊàêÂäüËΩ¨Êç¢Êñá‰ª∂ÂêéÊâçÊ†áËÆ∞‰∏∫Â∑≤ÂêåÊ≠•
        hasSyncedAttachmentsRef.current = true;
        updateField('productSolution', validFiles);
      }
    };

    convertAttachmentsToFiles();
  }, [attachments, formData.productSolution, updateField]);

  // Ë°®ÂçïÈ™åËØÅÂáΩÊï∞
  const validateForm = () => {
    const requiredFields = [
      { key: 'productName', label: t('validation.fields.productName') },
      { key: 'businessType', label: t('validation.fields.businessType') },
      { key: 'targetUsers', label: t('validation.fields.targetUsers') },
      { key: 'researchGoals', label: t('validation.fields.researchGoals') }
    ];

    const missingFields = requiredFields.filter(field => {
      const value = formData[field.key as keyof FormData];
      return !value || (typeof value === 'string' && value.trim() === '');
    });

    return missingFields;
  };

  // Ê£ÄÊü•Ë°®ÂçïÊòØÂê¶ÊúâÊïà
  const isFormValid = () => {
    return validateForm().length === 0;
  };

  // Â§ÑÁêÜ‰∏ã‰∏ÄÊ≠•ÁÇπÂáª
  const handleNext = () => {
    const missingFields = validateForm();
    if (missingFields.length > 0) {
      const fieldNames = missingFields.map(field => field.label).join('„ÄÅ');
      alert(t('validation.required', { fields: fieldNames }));
      return;
    }

    // Â∞ÜË∞ÉÁ†î‰ø°ÊÅØÂ≠òÂÇ®Âà∞ sessionStorageÔºå‰æõ outline È°µÈù¢‰ΩøÁî®
    const surveyInfo = {
      productName: formData.productName,
      businessType: formData.businessType,
      targetUsers: formData.targetUsers,
      researchGoals: formData.researchGoals,
      hasProductSolution: formData.productSolution && formData.productSolution.length > 0,
      productSolutionNames: formData.productSolution?.map(file => file.name).join(', ') || null,
      productSolutionCount: formData.productSolution?.length || 0,
    };

    try {
      sessionStorage.setItem('vf_surveyInfo', JSON.stringify(surveyInfo));
    } catch (e) {
      console.warn('Êó†Ê≥ïÂ≠òÂÇ®Ë∞ÉÁ†î‰ø°ÊÅØÂà∞ sessionStorage:', e);
    }

    router.push('/insight/outline');
  };
  // Áõ¥Êé•‰ΩøÁî® CopilotKit ÁöÑÂÜÖÈÉ®ËÅäÂ§© hookÔºå‰ª•‰æøËÉΩÂ§üÂú®È°µÈù¢Âä†ËΩΩÊó∂
  // ‰∏ªÂä®ÂêëÂè≥‰æß CopilotSidebar ÂèëÈÄÅ‰∏ÄÊù°Áî®Êà∑Ê∂àÊÅØ„ÄÇ
  const { sendMessage, messages } = useCopilotChatInternal();
  const hasSentInitialRef = useRef(false);

  // ‰ªé Zustand storeÔºà‰ºòÂÖàÔºâÊàñ query ‰∏≠ËØªÂèñ initialMessageÔºåÂπ∂Ëá™Âä®ÂèëÈÄÅÂà∞Âè≥‰æß Chat
  useEffect(() => {
    if (hasSentInitialRef.current) return;

    const sendInitialMessageToChat = (message: string, attachmentsData?: any[]) => {
      // Á≠âÂæÖCopilotKitÂÆåÂÖ®ÂàùÂßãÂåñ
      const checkAndSend = () => {
        // Ê£ÄÊü•CopilotKitÊòØÂê¶Â∑≤ÁªèÂáÜÂ§áÂ•Ω
        if (typeof sendMessage === 'function') {
          hasSentInitialRef.current = true;

          // Â¶ÇÊûúÊúâÈôÑ‰ª∂ÔºåÂ∞ÜÈôÑ‰ª∂‰ø°ÊÅØÈôÑÂä†Âà∞Ê∂àÊÅØ‰∏≠
          let fullMessage = message;
          if (attachmentsData && attachmentsData.length > 0) {
            const attachmentInfo = attachmentsData.map((item: any) =>
              `\n\nüìé ÈôÑ‰ª∂: ${item.name} (${(item.size / 1024).toFixed(2)} KB, ${item.type})`
            ).join('');
            fullMessage = message + attachmentInfo + '\n\nËØ∑Âü∫‰∫é‰ª•‰∏ä‰ø°ÊÅØÂíåÈôÑ‰ª∂ÂÜÖÂÆπÔºåÂ∏ÆÊàëÂàÜÊûêÂπ∂Â°´ÂÜôË°®Âçï„ÄÇ';
          }

          void sendMessage({ id: `init-${Date.now()}`, role: 'user', content: fullMessage });

          // ÂèëÈÄÅÂêéÊ∏ÖÁêÜ store ‰∏≠ÁöÑ initialMessageÔºà‰ΩÜ‰øùÁïô attachmentsÔºâ
          setInitialMessage('');
        } else {
          // Â¶ÇÊûúËøòÊ≤°ÂáÜÂ§áÂ•ΩÔºåÁªßÁª≠Á≠âÂæÖ
          setTimeout(checkAndSend, 100);
        }
      };

      // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥ÂÜçÂºÄÂßãÊ£ÄÊü•
      setTimeout(checkAndSend, 500);
    };

    // 1) ‰ºòÂÖà‰ªé Zustand store ËØªÂèñ
    if (initialMessage && initialMessage.trim()) {
      sendInitialMessageToChat(initialMessage.trim(), attachments);
      return;
    }

    // 2) ÂÖúÂ∫ïÔºö‰ªé URL query ËØªÂèñÔºàÂÖºÂÆπÂéÜÂè≤Ë°å‰∏∫Ôºâ
    const q = searchParams?.get('initialMessage')?.trim();
    if (q && !hasSentInitialRef.current) {
      sendInitialMessageToChat(q);
    }
  }, [searchParams, sendMessage, initialMessage, attachments, setInitialMessage]);


  useCopilotAdditionalInstructions({ instructions: "‰ΩøÁî®‰∏≠ÊñáÂõûÁ≠î", });

  // ËÆ©AIËÉΩÂ§üËØªÂèñË°®ÂçïÊï∞ÊçÆ
  useCopilotReadable({
    description: "ÂΩìÂâçË°®ÂçïÁöÑÊâÄÊúâÊï∞ÊçÆÔºåÂåÖÊã¨‰∫ßÂìÅÂêçÁß∞„ÄÅ‰∏öÂä°Á±ªÂûã„ÄÅÁõÆÊ†áÁî®Êà∑ÁîªÂÉè„ÄÅË∞ÉÁ†îÁõÆÊ†á„ÄÅ‰∫ßÂìÅÊñπÊ°àÊñá‰ª∂ÂíåÁî®Êà∑‰∏ä‰º†ÁöÑÈôÑ‰ª∂‰ø°ÊÅØ",
    value: {
      productName: formData.productName,
      businessType: formData.businessType,
      targetUsers: formData.targetUsers,
      researchGoals: formData.researchGoals,
      hasProductSolution: formData.productSolution && formData.productSolution.length > 0,
      productSolutionFiles: formData.productSolution && formData.productSolution.length > 0
        ? formData.productSolution.map(file => ({
          name: file.name,
          size: file.size,
          type: file.type,
          sizeInKB: (file.size / 1024).toFixed(2)
        }))
        : null,
      productSolutionCount: formData.productSolution?.length || 0,
      attachments: attachments.length > 0 ? attachments.map((item: any) => ({
        name: item.name,
        size: item.size,
        type: item.type,
        sizeInKB: (item.size / 1024).toFixed(2)
      })) : null,
      hasAttachments: attachments.length > 0,
      attachmentCount: attachments.length,
    },
  });

  // Êõ¥Êñ∞‰∫ßÂìÅÂêçÁß∞
  useCopilotAction({
    name: "updateProductName",
    description: t('actions.updateProductName'),
    parameters: [{
      name: "productName",
      type: "string",
      description: "Êñ∞ÁöÑ‰∫ßÂìÅÂêçÁß∞",
      required: true,
    }],
    handler: ({ productName }) => {
      updateField('productName', productName);
    },
  });

  // Êõ¥Êñ∞‰∏öÂä°Á±ªÂûã
  useCopilotAction({
    name: "updateBusinessType",
    description: t('actions.updateBusinessType'),
    parameters: [{
      name: "businessType",
      type: "string",
      description: "Êñ∞ÁöÑ‰∏öÂä°Á±ªÂûãÔºåÂ¶ÇÔºöÁ¨îËÆ∞APP„ÄÅÂ∑•ÂÖ∑Á±ª„ÄÅÁ§æ‰∫§Á±ªÁ≠â",
      required: true,
    }],
    handler: ({ businessType }) => {
      updateField('businessType', businessType);
    },
  });

  // Êõ¥Êñ∞ÁõÆÊ†áÁî®Êà∑Áæ§‰Ωì
  useCopilotAction({
    name: "updateTargetUsers",
    description: t('actions.updateTargetUsers'),
    parameters: [{
      name: "targetUsers",
      type: "string",
      description: "ÁõÆÊ†áÁî®Êà∑Áæ§‰ΩìÊèèËø∞ÔºåÂ¶ÇÔºöÂπ¥ËΩªÂ•≥ÊÄßÁî®Êà∑„ÄÅ‰∏ãÊ≤âÂ∏ÇÂú∫Áî®Êà∑„ÄÅÈáçÂ∫¶Ë¥≠Áâ©Áî®Êà∑Á≠â",
      required: true,
    }],
    handler: ({ targetUsers }) => {
      updateField('targetUsers', targetUsers);
    },
  });

  // Êõ¥Êñ∞Ë∞ÉÁ†îÁõÆÊ†á
  useCopilotAction({
    name: "updateResearchGoals",
    description: t('actions.updateResearchGoals'),
    parameters: [{
      name: "researchGoals",
      type: "string",
      description: "Ë∞ÉÁ†îÁõÆÊ†áÔºåÂ¶ÇÔºö‰∫ÜËß£Áî®Êà∑‰ΩøÁî®‰π†ÊÉØ„ÄÅÈ™åËØÅ‰∫ßÂìÅÂäüËÉΩÈúÄÊ±Ç„ÄÅÂàÜÊûêÁî®Êà∑ÁóõÁÇπÁ≠â",
      required: true,
    }],
    handler: ({ researchGoals }) => {
      updateField('researchGoals', researchGoals);
    },
  });

  // Ê∏ÖÁ©∫Ë°®Âçï
  useCopilotAction({
    name: "clearForm",
    description: t('actions.clearForm'),
    parameters: [],
    handler: () => {
      clearForm();
      if (fileInputRef.current) {
        fileInputRef.current.value = "";
      }
    },
  });

  // // Â°´ÂÖÖÁ§∫‰æãÊï∞ÊçÆ
  useCopilotAction({
    name: "fillSampleData",
    description: t('actions.fillSampleData'),
    parameters: [],
    handler: () => {
      setFormData({
        productName: "Dreamoo",
        businessType: "Á¨îËÆ∞APP„ÄÅÂ∑•ÂÖ∑Á±ª„ÄÅÁ§æ‰∫§Á±ª",
        targetUsers: "Âπ¥ËΩªÂ•≥ÊÄßÁî®Êà∑„ÄÅ‰∏ãÊ≤âÂ∏ÇÂú∫Áî®Êà∑„ÄÅÈáçÂ∫¶Ë¥≠Áâ©Áî®Êà∑Á≠â\n\nËØ∑ËØ¶ÁªÜÊèèËø∞ÊÇ®ÁöÑÁõÆÊ†áÁî®Êà∑Áæ§‰ΩìÁâπÂæÅ",
        researchGoals: "‰∫ÜËß£Áî®Êà∑‰ΩøÁî®‰π†ÊÉØ„ÄÅÈ™åËØÅ‰∫ßÂìÅÂäüËÉΩÈúÄÊ±Ç„ÄÅÂàÜÊûêÁî®Êà∑ÁóõÁÇπÁ≠â\n\nËØ∑ÊèèËø∞ÊÇ®Â∏åÊúõÈÄöËøáË∞ÉÁ†î‰∫ÜËß£‰ªÄ‰πà",
        // ‰∏çÊ∏ÖÁ©∫Áé∞ÊúâÁöÑ‰∫ßÂìÅÊñπÊ°àÊñá‰ª∂
        productSolution: formData.productSolution,
      });
    },
  });

  // Êô∫ËÉΩÂª∫ËÆÆ
  useCopilotChatSuggestions({
    instructions: t('copilot.suggestions'),
    minSuggestions: 3,
    maxSuggestions: 3,
  });

  return (
    <div style={{ "--copilot-kit-primary-color": "oklch(0.6 0.2 300)" } as CopilotKitCSSProperties}>
      <SidebarProvider>
        <AppSidebar />
        <SidebarInset className="flex flex-col h-screen">
          <div className="flex flex-1 flex-col bg-gray-100 min-h-0">
            {/* ÂèØÊªöÂä®Âå∫Âüü - ÂåÖÂê´È°∂ÈÉ®Âíå‰∏≠Èó¥ÂÜÖÂÆπ */}
            <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide">
              {/* È°∂ÈÉ® - ÊµÅÁ®ãÁä∂ÊÄÅÊ†è */}
              <div className="bg-white rounded-lg shadow-sm px-6 py-6">
                <Stepper value={1} className="w-full">
                  <StepperNav className="flex justify-between items-center">
                    <StepperItem step={1} completed={1 > 1}>
                      <StepperTrigger className="flex flex-col items-center gap-3">
                        <StepperIndicator className="w-10 h-10 text-sm font-medium bg-gray-200 text-gray-700 border-2 border-dashed border-primary">
                          1
                        </StepperIndicator>
                        <div className="text-center">
                          <StepperTitle className="text-sm font-medium text-primary">{t('steps.step1.title')}</StepperTitle>
                          <StepperDescription className="text-xs text-gray-500 mt-1">{t('steps.step1.description')}</StepperDescription>
                        </div>
                      </StepperTrigger>
                      <StepperSeparator className="mx-4 flex-1 bg-gray-200 h-0.5" />
                    </StepperItem>

                    <StepperItem step={2} completed={1 > 2}>
                      <StepperTrigger className="flex flex-col items-center gap-3">
                        <StepperIndicator className="w-10 h-10 text-sm font-medium bg-gray-200 text-gray-500">
                          2
                        </StepperIndicator>
                        <div className="text-center">
                          <StepperTitle className="text-sm font-medium text-gray-500">{t('steps.step2.title')}</StepperTitle>
                          <StepperDescription className="text-xs text-gray-500 mt-1">{t('steps.step2.description')}</StepperDescription>
                        </div>
                      </StepperTrigger>
                      <StepperSeparator className="mx-4 flex-1 bg-gray-200 h-0.5" />
                    </StepperItem>

                    <StepperItem step={3} completed={1 > 3}>
                      <StepperTrigger className="flex flex-col items-center gap-3">
                        <StepperIndicator className="w-10 h-10 text-sm font-medium bg-gray-200 text-gray-500">
                          3
                        </StepperIndicator>
                        <div className="text-center">
                          <StepperTitle className="text-sm font-medium text-gray-500">{t('steps.step3.title')}</StepperTitle>
                          <StepperDescription className="text-xs text-gray-500 mt-1">{t('steps.step3.description')}</StepperDescription>
                        </div>
                      </StepperTrigger>
                    </StepperItem>
                  </StepperNav>
                </Stepper>
              </div>

              {/* ‰∏≠Èó¥ÂÜÖÂÆπÂå∫ */}
              <div className="bg-white rounded-lg shadow-sm p-6">
                <SurveyForm
                  fileInputRef={fileInputRef}
                />
              </div>
            </div>

            {/* Â∫ïÈÉ®ÂØºËà™ - Âê∏Â∫ïÊòæÁ§∫ */}
            <div className="bg-gray-100 p-4 flex-shrink-0">
              <div className="bg-white rounded-lg shadow-sm px-6 py-6">
                <div className="flex items-center justify-between">
                  <div className="flex-1">
                    <h3 className="text-lg font-semibold text-gray-900 mb-2">
                      {t('nextPreview')}
                    </h3>
                    <p className="text-gray-600">
                      {t('nextDescription')}
                    </p>
                  </div>
                  <div className="flex items-center gap-4">
                    <Button
                      variant="outline"
                      onClick={() => router.push('/dashboard')}
                      className="flex items-center gap-2"
                    >
                      <ArrowLeft className="w-4 h-4" />
                      {t('previous')}
                    </Button>
                    <Button
                      onClick={handleNext}
                      disabled={!isFormValid()}
                      className={`flex items-center gap-2 transition-all duration-200 ${isFormValid()
                        ? 'bg-primary hover:bg-primary/90 text-white'
                        : 'bg-primary/80 text-white cursor-not-allowed hover:bg-primary/70'
                        }`}
                    >
                      {t('next')}
                      <ArrowRight className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </SidebarInset>
        <CopilotSidebar
          clickOutsideToClose={false}
          defaultOpen={true}
          labels={{
            title: t('copilot.title'),
            initial: t('copilot.initial')
          }}
          imageUploadsEnabled={true}
        />
      </SidebarProvider>
    </div>
  )
}

interface SurveyFormProps {
  fileInputRef: React.RefObject<HTMLInputElement>;
}

function SurveyForm({ fileInputRef }: SurveyFormProps) {
  const t = useTranslations('goal');
  const { formData, updateField } = useFormStore();

  const handleInputChange = (field: keyof FormData, value: string) => {
    updateField(field, value);
  };

  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {
    const files = event.target.files;
    if (!files || files.length === 0) return;

    const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
    const maxSize = 100 * 1024 * 1024; // 100MB

    const validFiles: File[] = [];
    const currentFiles = formData.productSolution || [];

    // È™åËØÅÊâÄÊúâÊñá‰ª∂
    for (let i = 0; i < files.length; i++) {
      const file = files[i];

      // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
      if (!allowedTypes.includes(file.type)) {
        alert(t('fileUpload.invalidType') + `: ${file.name}`);
        continue;
      }

      // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è
      if (file.size > maxSize) {
        alert(t('fileUpload.tooLarge') + `: ${file.name}`);
        continue;
      }

      validFiles.push(file);
    }

    // ÊâπÈáèËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ
    if (validFiles.length > 0) {
      const filePromises = validFiles.map((file) => {
        return new Promise<File & { _content?: string }>((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const content = e.target?.result as string;
            const fileWithContent = Object.assign(file, { _content: content });
            resolve(fileWithContent);
          };
          reader.readAsDataURL(file);
        });
      });

      Promise.all(filePromises).then((filesWithContent) => {
        // Ê∑ªÂä†Âà∞Áé∞ÊúâÊñá‰ª∂ÂàóË°®
        updateField('productSolution', [...currentFiles, ...filesWithContent]);
      });
    }

    // Ê∏ÖÁ©∫ inputÔºåÂÖÅËÆ∏ÈáçÂ§ç‰∏ä‰º†Áõ∏ÂêåÊñá‰ª∂
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const handleRemoveFile = (index: number) => {
    console.log('Âà†Èô§Êñá‰ª∂:', index, 'ÂΩìÂâçÊñá‰ª∂Êï∞:', formData.productSolution?.length);
    const currentFiles = formData.productSolution || [];
    const newFiles = currentFiles.filter((_, i) => i !== index);
    console.log('Âà†Èô§ÂêéÊñá‰ª∂Êï∞:', newFiles.length);

    // Âà†Èô§Êñá‰ª∂

    updateField('productSolution', newFiles.length > 0 ? newFiles : []);
  };

  const handleUploadClick = () => {
    fileInputRef.current?.click();
  };

  return (
    <div className="bg-white rounded-lg shadow-sm p-8">
      {/* Ë°®ÂçïÊ†áÈ¢ò */}
      <div className="flex items-center gap-3 mb-8">
        <div className="w-8 h-8 bg-primary/10 rounded-lg flex items-center justify-center">
          <FileText className="w-5 h-5 text-primary" />
        </div>
        <h1 className="text-2xl font-semibold text-gray-900">{t('title')}</h1>
      </div>

      <div className="space-y-6">
        {/* ‰∫ßÂìÅÂêçÁß∞Âíå‰∏öÂä°Á±ªÂûã - Âπ∂ÊéíÂ∏ÉÂ±Ä */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {t('form.productName.label')} <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.productName}
              onChange={(e) => handleInputChange('productName', e.target.value)}
              placeholder={t('form.productName.placeholder')}
              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
            />
            <p className="text-xs text-gray-500 mt-1">{t('form.productName.help')}</p>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
              {t('form.businessType.label')} <span className="text-red-500">*</span>
            </label>
            <input
              type="text"
              value={formData.businessType}
              onChange={(e) => handleInputChange('businessType', e.target.value)}
              placeholder={t('form.businessType.placeholder')}
              className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
            />
            <p className="text-xs text-gray-500 mt-1">{t('form.businessType.help')}</p>
          </div>
        </div>

        {/* ÁõÆÊ†áÁî®Êà∑ÁîªÂÉè */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            {t('form.targetUsers.label')} <span className="text-red-500">*</span>
          </label>
          <textarea
            value={formData.targetUsers}
            onChange={(e) => handleInputChange('targetUsers', e.target.value)}
            placeholder={t('form.targetUsers.placeholder')}
            rows={4}
            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all resize-none"
          />
          <p className="text-xs text-gray-500 mt-1">{t('form.targetUsers.help')}</p>
        </div>

        {/* Ë∞ÉÁ†îÁõÆÊ†á */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            {t('form.researchGoals.label')} <span className="text-red-500">*</span>
          </label>
          <textarea
            value={formData.researchGoals}
            onChange={(e) => handleInputChange('researchGoals', e.target.value)}
            placeholder={t('form.researchGoals.placeholder')}
            rows={4}
            className="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all resize-none"
          />
          <p className="text-xs text-gray-500 mt-1">{t('form.researchGoals.help')}</p>
        </div>

        {/* ‰∫ßÂìÅÊñπÊ°àÊñá‰ª∂‰∏ä‰º† */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            {t('form.productSolution.label')}
            {formData.productSolution && formData.productSolution.length > 0 && (
              <span className="ml-2 text-xs text-gray-500">
                ({formData.productSolution.length} ‰∏™Êñá‰ª∂)
              </span>
            )}
          </label>

          {/* Â∑≤‰∏ä‰º†Êñá‰ª∂ÂàóË°® */}
          {formData.productSolution && formData.productSolution.length > 0 && (
            <div className="mb-3 space-y-2">
              {formData.productSolution.map((file, index) => (
                <div
                  key={index}
                  className="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors"
                >
                  <div className="flex items-center gap-3 flex-1 min-w-0">
                    <FileText className="w-5 h-5 text-primary flex-shrink-0" />
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-gray-900 truncate">
                        {file.name}
                      </p>
                      <p className="text-xs text-gray-500">
                        {(file.size / 1024).toFixed(2)} KB
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={(e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      handleRemoveFile(index);
                    }}
                    className="ml-2 p-1 hover:bg-red-100 rounded-full transition-colors group"
                    title="Âà†Èô§Êñá‰ª∂"
                  >
                    <X className="w-4 h-4 text-gray-400 group-hover:text-red-600" />
                  </button>
                </div>
              ))}
            </div>
          )}

          {/* ‰∏ä‰º†Âå∫Âüü */}
          <div
            onClick={handleUploadClick}
            className="border-2 border-dashed border-gray-200 rounded-lg p-8 text-center hover:border-primary/30 hover:bg-primary/5 transition-all cursor-pointer"
          >
            <input
              ref={fileInputRef}
              type="file"
              accept=".pdf,.png,.jpg,.jpeg"
              multiple
              onChange={handleFileChange}
              className="hidden"
            />
            <div className="flex flex-col items-center gap-3">
              <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center">
                <Plus className="w-6 h-6 text-gray-400" />
              </div>
              <div>
                <p className="text-sm font-medium text-gray-700">
                  {formData.productSolution && formData.productSolution.length > 0
                    ? 'ÁªßÁª≠Ê∑ªÂä†Êñá‰ª∂'
                    : t('form.productSolution.uploadText')}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  {t('form.productSolution.uploadHelp')} ‚Ä¢ ÊîØÊåÅÊâπÈáè‰∏ä‰º†
                </p>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}

