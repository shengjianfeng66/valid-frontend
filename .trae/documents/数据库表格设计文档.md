# 数据库表格设计文档

## 1. 概述

本文档描述了系统的完整数据库设计，包含现有的基础功能表格和新增的业务功能表格。数据库采用PostgreSQL，支持用户管理、订单处理、内容管理以及访谈调研等核心业务功能。

## 2. 现有基础表格

### 2.1 用户表 (users)

**表名**: `users`  
**描述**: 存储系统用户的基本信息和认证数据

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | integer | PRIMARY KEY, IDENTITY | 用户唯一标识符 |
| uuid | varchar(255) | NOT NULL, UNIQUE | 用户UUID |
| email | varchar(255) | NOT NULL | 用户邮箱 |
| created_at | timestamp with time zone | | 创建时间 |
| nickname | varchar(255) | | 用户昵称 |
| avatar_url | varchar(255) | | 头像URL |
| locale | varchar(50) | | 语言设置 |
| signin_type | varchar(50) | | 登录类型 |
| signin_ip | varchar(255) | | 登录IP |
| signin_provider | varchar(50) | | 登录提供商 |
| signin_openid | varchar(255) | | 第三方登录ID |
| invite_code | varchar(255) | NOT NULL, DEFAULT '' | 邀请码 |
| updated_at | timestamp with time zone | | 更新时间 |
| invited_by | varchar(255) | NOT NULL, DEFAULT '' | 邀请人 |
| is_affiliate | boolean | NOT NULL, DEFAULT false | 是否为联盟用户 |

**索引**:
- `email_provider_unique_idx`: (email, signin_provider) UNIQUE

### 2.2 订单表 (orders)

**表名**: `orders`  
**描述**: 存储用户订单信息和支付状态

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | integer | PRIMARY KEY, IDENTITY | 订单ID |
| order_no | varchar(255) | NOT NULL, UNIQUE | 订单号 |
| created_at | timestamp with time zone | | 创建时间 |
| user_uuid | varchar(255) | NOT NULL, DEFAULT '' | 用户UUID |
| user_email | varchar(255) | NOT NULL, DEFAULT '' | 用户邮箱 |
| amount | integer | NOT NULL | 订单金额 |
| interval | varchar(50) | | 订阅周期 |
| expired_at | timestamp with time zone | | 过期时间 |
| status | varchar(50) | NOT NULL | 订单状态 |
| stripe_session_id | varchar(255) | | Stripe会话ID |
| credits | integer | NOT NULL | 积分数量 |
| currency | varchar(50) | | 货币类型 |
| sub_id | varchar(255) | | 订阅ID |
| sub_interval_count | integer | | 订阅间隔数 |
| sub_cycle_anchor | integer | | 订阅周期锚点 |
| sub_period_end | integer | | 订阅周期结束 |
| sub_period_start | integer | | 订阅周期开始 |
| sub_times | integer | | 订阅次数 |
| product_id | varchar(255) | | 产品ID |
| product_name | varchar(255) | | 产品名称 |
| valid_months | integer | | 有效月数 |
| order_detail | text | | 订单详情 |
| paid_at | timestamp with time zone | | 支付时间 |
| paid_email | varchar(255) | | 支付邮箱 |
| paid_detail | text | | 支付详情 |

### 2.3 API密钥表 (apikeys)

**表名**: `apikeys`  
**描述**: 存储用户的API访问密钥

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | integer | PRIMARY KEY, IDENTITY | 密钥ID |
| api_key | varchar(255) | NOT NULL, UNIQUE | API密钥 |
| title | varchar(100) | | 密钥标题 |
| user_uuid | varchar(255) | NOT NULL | 用户UUID |
| created_at | timestamp with time zone | | 创建时间 |
| status | varchar(50) | | 状态 |

### 2.4 积分表 (credits)

**表名**: `credits`  
**描述**: 存储用户积分交易记录

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | integer | PRIMARY KEY, IDENTITY | 记录ID |
| trans_no | varchar(255) | NOT NULL, UNIQUE | 交易号 |
| created_at | timestamp with time zone | | 创建时间 |
| user_uuid | varchar(255) | NOT NULL | 用户UUID |
| trans_type | varchar(50) | NOT NULL | 交易类型 |
| credits | integer | NOT NULL | 积分数量 |
| order_no | varchar(255) | | 订单号 |
| expired_at | timestamp with time zone | | 过期时间 |

### 2.5 分类表 (categories)

**表名**: `categories`  
**描述**: 存储内容分类信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | integer | PRIMARY KEY, IDENTITY | 分类ID |
| uuid | varchar(255) | NOT NULL, UNIQUE | 分类UUID |
| name | varchar(255) | NOT NULL, UNIQUE | 分类名称 |
| title | varchar(255) | NOT NULL | 分类标题 |
| description | text | | 分类描述 |
| status | varchar(50) | | 状态 |
| sort | integer | NOT NULL, DEFAULT 0 | 排序 |
| created_at | timestamp with time zone | | 创建时间 |
| updated_at | timestamp with time zone | | 更新时间 |

### 2.6 文章表 (posts)

**表名**: `posts`  
**描述**: 存储文章内容

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | integer | PRIMARY KEY, IDENTITY | 文章ID |
| uuid | varchar(255) | NOT NULL, UNIQUE | 文章UUID |
| slug | varchar(255) | | URL别名 |
| title | varchar(255) | | 文章标题 |
| description | text | | 文章描述 |
| content | text | | 文章内容 |
| created_at | timestamp with time zone | | 创建时间 |
| updated_at | timestamp with time zone | | 更新时间 |
| status | varchar(50) | | 状态 |
| cover_url | varchar(255) | | 封面URL |
| author_name | varchar(255) | | 作者姓名 |
| author_avatar_url | varchar(255) | | 作者头像URL |
| locale | varchar(50) | | 语言 |
| category_uuid | varchar(255) | | 分类UUID |

### 2.7 联盟表 (affiliates)

**表名**: `affiliates`  
**描述**: 存储联盟推广信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | integer | PRIMARY KEY, IDENTITY | 记录ID |
| user_uuid | varchar(255) | NOT NULL | 用户UUID |
| created_at | timestamp with time zone | | 创建时间 |
| status | varchar(50) | NOT NULL, DEFAULT '' | 状态 |
| invited_by | varchar(255) | NOT NULL | 邀请人 |
| paid_order_no | varchar(255) | NOT NULL, DEFAULT '' | 付费订单号 |
| paid_amount | integer | NOT NULL, DEFAULT 0 | 付费金额 |
| reward_percent | integer | NOT NULL, DEFAULT 0 | 奖励百分比 |
| reward_amount | integer | NOT NULL, DEFAULT 0 | 奖励金额 |

### 2.8 反馈表 (feedbacks)

**表名**: `feedbacks`  
**描述**: 存储用户反馈信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | integer | PRIMARY KEY, IDENTITY | 反馈ID |
| created_at | timestamp with time zone | | 创建时间 |
| status | varchar(50) | | 状态 |
| user_uuid | varchar(255) | | 用户UUID |
| content | text | | 反馈内容 |
| rating | integer | | 评分 |

## 3. 新增业务表格

### 3.1 组织表 (organization)

**表名**: `organization`  
**描述**: 存储组织机构信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | text | PRIMARY KEY, DEFAULT uuid_generate_v4() | 组织ID |
| created_at | timestamp with time zone | DEFAULT timezone('utc', now()) | 创建时间 |
| name | text | | 组织名称 |
| image_url | text | | 组织图片URL |

### 3.2 业务用户表 (user)

**表名**: `user`  
**描述**: 业务用户信息（建议与现有users表合并）

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | text | PRIMARY KEY | 用户ID |
| created_at | timestamp with time zone | DEFAULT timezone('utc', now()) | 创建时间 |
| email | text | | 用户邮箱 |
| organization_id | text | FOREIGN KEY → organization(id) | 所属组织ID |

### 3.3 产品表 (product)

**表名**: `product`  
**描述**: 存储产品信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | text | PRIMARY KEY, DEFAULT uuid_generate_v4() | 产品ID |
| created_at | timestamp with time zone | DEFAULT timezone('utc', now()) | 创建时间 |
| name | text | | 产品名称 |
| brief | text | | 产品简介 |
| image_url | text | | 产品图片URL |
| organization_id | text | FOREIGN KEY → organization(id) | 所属组织ID |
| user_id | text | FOREIGN KEY → user(id) | 创建用户ID |

### 3.4 访谈表 (interview)

**表名**: `interview`  
**描述**: 存储访谈项目信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | text | PRIMARY KEY | 访谈ID |
| created_at | timestamp with time zone | DEFAULT timezone('utc', now()) | 创建时间 |
| name | text | | 访谈名称 |
| description | text | | 访谈描述 |
| proposal | jsonb | | 提案内容 |
| outline | jsonb | | 访谈大纲 |
| questionnaire | jsonb | | 问卷内容 |
| participants | jsonb | | 被试者信息 |
| duration | integer | | 访谈时长 |
| organization_id | text | FOREIGN KEY → organization(id) | 所属组织ID |
| user_id | text | FOREIGN KEY → user(id) | 创建用户ID |
| project_id | text | FOREIGN KEY → product(id) | 关联产品ID |

### 3.5 被试人表 (interviewee)

**表名**: `interviewee`  
**描述**: 存储被试人信息

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | serial | PRIMARY KEY | 被试人ID |
| created_at | timestamp with time zone | DEFAULT timezone('utc', now()) | 创建时间 |
| name | text | | 被试人姓名 |
| content | jsonb | | 被试人特征（年龄、职业等） |
| source | integer | DEFAULT 0 | 被试人类型（0:真人 1:模拟） |
| organization_id | text | FOREIGN KEY → organization(id) | 所属组织ID |
| user_id | text | FOREIGN KEY → user(id) | 创建用户ID |
| project_id | text | FOREIGN KEY → product(id) | 关联产品ID |

### 3.6 访谈返回表 (response)

**表名**: `response`  
**描述**: 存储访谈结果和分析数据

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | serial | PRIMARY KEY | 返回记录ID |
| created_at | timestamp with time zone | DEFAULT timezone('utc', now()) | 创建时间 |
| interview_id | text | FOREIGN KEY → interview(id) | 访谈ID |
| duration | integer | | 访谈时长 |
| details | jsonb | | 用户原声记录 |
| analytics | jsonb | | 访谈分析结果 |
| interviewee_id | integer | FOREIGN KEY → interviewee(id) | 被试人ID |

## 4. 表关系说明

### 4.1 现有表关系
- `orders.user_uuid` → `users.uuid`
- `apikeys.user_uuid` → `users.uuid`
- `credits.user_uuid` → `users.uuid`
- `posts.category_uuid` → `categories.uuid`
- `affiliates.user_uuid` → `users.uuid`
- `feedbacks.user_uuid` → `users.uuid`

### 4.2 新增表关系
- `user.organization_id` → `organization.id`
- `product.organization_id` → `organization.id`
- `product.user_id` → `user.id`
- `interview.organization_id` → `organization.id`
- `interview.user_id` → `user.id`
- `interview.project_id` → `product.id`
- `interviewee.organization_id` → `organization.id`
- `interviewee.user_id` → `user.id`
- `interviewee.project_id` → `product.id`
- `response.interview_id` → `interview.id`
- `response.interviewee_id` → `interviewee.id`

## 5. 索引建议

### 5.1 现有索引
- `users`: (email, signin_provider) UNIQUE
- `orders`: (order_no) UNIQUE
- `apikeys`: (api_key) UNIQUE
- `credits`: (trans_no) UNIQUE
- `categories`: (uuid) UNIQUE, (name) UNIQUE
- `posts`: (uuid) UNIQUE

### 5.2 建议新增索引
- `organization`: (name)
- `user`: (email), (organization_id)
- `product`: (organization_id), (user_id), (name)
- `interview`: (organization_id), (user_id), (project_id)
- `interviewee`: (organization_id), (user_id), (project_id)
- `response`: (interview_id), (interviewee_id), (created_at)

## 6. 数据类型说明

- **text**: 可变长度字符串，适用于长文本内容
- **varchar(n)**: 限制长度的字符串
- **integer**: 32位整数
- **serial**: 自增整数
- **boolean**: 布尔值
- **timestamp with time zone**: 带时区的时间戳
- **jsonb**: 二进制JSON格式，支持索引和查询

## 7. 合并建议

### 7.1 用户表合并
建议将新的`user`表与现有的`users`表合并，在`users`表中添加`organization_id`字段：

```sql
ALTER TABLE users ADD COLUMN organization_id text;
ALTER TABLE users ADD CONSTRAINT users_organization_id_fkey 
  FOREIGN KEY (organization_id) REFERENCES organization(id);
```

### 7.2 数据一致性
- 统一使用UUID作为主键格式
- 统一时间戳格式和时区设置
- 统一外键约束命名规范

## 8. 性能优化建议

1. **分区策略**: 对于大表如`response`，可考虑按时间分区
2. **索引优化**: 根据查询模式创建复合索引
3. **JSONB优化**: 为常用的JSONB字段创建GIN索引
4. **连接池**: 配置合适的数据库连接池大小
5. **查询优化**: 使用EXPLAIN分析查询计划

## 9. 安全考虑

1. **数据加密**: 敏感数据字段考虑加密存储
2. **访问控制**: 实施行级安全策略
3. **审计日志**: 记录重要操作的审计信息
4. **备份策略**: 定期备份和恢复测试

---

*文档版本: 1.0*  
*最后更新: 2024年*